{% extends "layout.html" %} 
{% block title %}Elenco Commesse{% endblock %}

{% block content %}
<div class="container lista-commesse-page">
    <h1>üìã Elenco Commesse</h1>

    <!-- üîπ Pulsante Nuova Commessa -->
    <div class="top-bar">
        <a href="{{ url_for('aggiungi_commessa') }}" class="btn btn-add">‚ûï Nuova Commessa</a>
    </div>

    <!-- üîç SEZIONE RICERCA E FILTRI -->
    <div class="filter-box">
        <div class="search-row">
            <input type="text" id="searchInput" placeholder="üîç Cerca per nome, tipo intervento o veicolo...">
            <div class="filter-buttons">
                <button class="btn btn-filter" id="toggleAdvanced">‚öô Filtri</button>
                <button class="btn btn-reset" onclick="resetFiltri()">üîÑ Reset</button>
            </div>
        </div>

        <div class="advanced-filters hidden" id="advancedFilters">
            <select id="filterTipo">
                <option value="">Tipo intervento...</option>
                <option value="Carrozzeria">Carrozzeria</option>
                <option value="Allestimento">Allestimento</option>
                <option value="Riparazione">Riparazione</option>
                <option value="Tetto a Soffietto">Tetto a Soffietto</option>
            </select>

            <label>Dal:</label>
            <input type="date" id="filterDataDa">
            <label>Al:</label>
            <input type="date" id="filterDataA">

            <button class="btn btn-apply" onclick="filtraAvanzato()">Applica</button>
        </div>
    </div>

    <!-- üìã Tabella -->
    <table id="commesseTable">
        <thead>
            <tr>
                <th class="col-id">ID</th>
                <th>Nome</th>
                <th>Tipo Intervento</th>
                <th>Marca</th>
                <th>Modello</th>
                <th class="narrow">Data Conferma</th>
                <th class="narrow">Data Inizio</th>
                <th class="narrow">Data Consegna</th>
                <th class="narrow num">Ore Prev.</th>
                <th class="narrow num">Ore Eseg.</th>
                <th class="narrow num">Ore Rim.</th>
                <th class="actions-col">Azioni</th>
            </tr>
        </thead>
        <tbody>
            {% for com in commesse %}
            <!-- riga verde se i lavori sono iniziati -->
            <tr class="{% if com.data_inizio %}riga-iniziata{% endif %}">
                <td class="col-id num">{{ com.id }}</td>
                <td class="text">{{ com.nome }}</td>
                <td class="text">{{ com.tipo_intervento }}</td>
                <td class="text">{{ com.marca_veicolo }}</td>
                <td class="text">{{ com.modello_veicolo }}</td>
                <td class="text">{{ com.data_conferma or '-' }}</td>
                <td class="text">{{ com.data_inizio or '-' }}</td>
                <td class="text">{{ com.data_consegna or '-' }}</td>
                <td class="num">{{ com.ore_necessarie or '-' }}</td>
                <td class="num">{{ com.ore_eseguite or '-' }}</td>
                <td class="num">
                    {% if com.ore_necessarie and com.ore_eseguite %}
                        {{ com.ore_necessarie - com.ore_eseguite }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="actions">
                    <a href="{{ url_for('modifica_commessa', id=com.id) }}" class="btn btn-edit">‚úè Modifica</a>
                    <a href="{{ url_for('conferma_consegna', id=com.id) }}" class="btn btn-view" onclick="return confirm('Segnare come consegnata questa commessa?')">üöö Consegna</a>
                    <a href="{{ url_for('elimina_commessa', id=com.id) }}" class="btn btn-delete" onclick="return confirm('Eliminare questa commessa?')">üóë Elimina</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<style>
/* allineo top-bar, filtri e tabella dentro il contenitore grigio */
.lista-commesse-page .top-bar,
.lista-commesse-page .filter-box,
.lista-commesse-page #commesseTable {
    width: 96%;
    margin: 0 auto;
}

/* === SEZIONE FILTRI MODERNA === */
.filter-box {
    background: #22283a;
    border: 1px solid #333a50;
    border-radius: 10px;
    padding: 15px 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
}

.search-row {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    align-items: center;
    gap: 10px;
}

.search-row input {
    flex: 1;
    min-width: 300px;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #444;
    background-color: #1c1f2b;
    color: #fff;
    font-size: 14px;
}

.filter-buttons {
    display: flex;
    gap: 8px;
}

.btn-filter, .btn-reset, .btn-apply {
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 13px;
    border: none;
    cursor: pointer;
    transition: 0.2s;
}
.btn-filter { background-color: #00b4ff; color: white; }
.btn-reset  { background-color: #ffc107; color: black; }
.btn-apply  { background-color: #28a745; color: white; }

.btn-filter:hover, .btn-reset:hover, .btn-apply:hover {
    transform: scale(1.05);
    opacity: 0.9;
}

.advanced-filters {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    align-items: center;
    gap: 10px;
    margin-top: 15px;
    font-size: 13px;
}

.advanced-filters select,
.advanced-filters input[type="date"] {
    padding: 8px;
    border-radius: 6px;
    background-color: #1e2230;
    color: #fff;
    border: 1px solid #555;
}
.hidden { display: none; }

/* === STILE TABELLA SOLO PER QUESTA PAGINA === */
#commesseTable {
    border-collapse: collapse;
    font-size: 12px;
    background-color: #2f3241;
    border-radius: 8px;
    overflow: hidden;
}

/* celle: testo di default allineato a sinistra */
#commesseTable th,
#commesseTable td {
    border: 1px solid #444;
    padding: 6px 6px;
    color: #e0e0e0;
    white-space: nowrap;
    text-align: left;
}

/* intestazioni */
#commesseTable th {
    background-color: #00a6c7;
    color: #fff;
    font-weight: 600;
    font-size: 12px;
}

/* colonne strette */
#commesseTable th.narrow,
#commesseTable td.narrow {
    width: 80px;
}

/* colonna ID pi√π stretta */
#commesseTable th.col-id,
#commesseTable td.col-id {
    width: 40px;
}

/* colonne numeriche a destra */
#commesseTable th.num,
#commesseTable td.num {
    text-align: right;
}

/* azioni centrate */
.actions-col {
    width: 230px;
    text-align: center;
}

/* righe alterne */
#commesseTable tbody tr:nth-child(even) {
    background-color: #34374a;
}

/* riga con lavori iniziati in verde tenue */
#commesseTable tbody tr.riga-iniziata td {
    background-color: #245430;
}

/* Pulsanti azioni */
.actions {
    display: flex;
    justify-content: center;
    gap: 6px;
}
.actions .btn {
    font-size: 11px;
    padding: 5px 8px;
    border-radius: 6px;
    color: #fff;
    text-decoration: none;
    cursor: pointer;
    transition: 0.2s;
}
.btn-edit   { background-color: #28a745; }
.btn-view   { background-color: #00bfff; }
.btn-delete { background-color: #dc3545; }

.actions .btn:hover {
    opacity: 0.85;
    transform: scale(1.04);
}
</style>

<script>
    // Ricerca
    const input = document.getElementById("searchInput");
    input.addEventListener("keyup", function() {
        const filter = input.value.toLowerCase();
        const rows = document.querySelectorAll("#commesseTable tbody tr");
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(filter) ? "" : "none";
        });
    });

    // Filtri avanzati
    const toggleBtn  = document.getElementById("toggleAdvanced");
    const filtersBox = document.getElementById("advancedFilters");
    toggleBtn.addEventListener("click", () => {
        filtersBox.classList.toggle("hidden");
    });
</script>
{% endblock %}
