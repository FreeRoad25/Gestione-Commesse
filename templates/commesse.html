{% extends "layout.html" %}
{% block title %}Elenco Commesse{% endblock %}

{% block content %}
<div class="commesse-wrapper">
  <div class="commesse-card">
    <h1>üìã Elenco Commesse</h1>

    <div class="top-bar">
      <a href="{{ url_for('aggiungi_commessa') }}" class="btn btn-add">‚ûï Nuova Commessa</a>
    </div>

    <div class="filter-box">
      <div class="search-row">
        <input type="text" id="searchInput" placeholder="üîç Cerca per nome, tipo intervento o veicolo...">
        <div class="filter-buttons">
          <button class="btn btn-filter" id="toggleAdvanced" type="button">‚öô Filtri</button>
          <button class="btn btn-reset" type="button" onclick="resetFiltri()">üîÑ Reset</button>
        </div>
      </div>

      <div class="advanced-filters hidden" id="advancedFilters">
        <select id="filterTipo">
          <option value="">Tipo intervento...</option>
          <option value="Carrozzeria">Carrozzeria</option>
          <option value="Allestimento">Allestimento</option>
          <option value="Riparazione">Riparazione</option>
          <option value="Tetto a Soffietto">Tetto a Soffietto</option>
        </select>

        <label>Dal:</label>
        <input type="date" id="filterDataDa">
        <label>Al:</label>
        <input type="date" id="filterDataA">

        <button class="btn btn-apply" type="button" onclick="filtraAvanzato()">Applica</button>
      </div>
    </div>

    <table id="commesseTable">
      <thead>
        <tr>
          <th class="c-nome">Nome</th>
          <th class="c-tipo">Tipo</th>
          <th class="c-veicolo">Veicolo</th>

          <th class="c-date">Conf</th>
          <th class="c-date">Arr</th>
          <th class="c-date">Iniz</th>
          <th class="c-date">Cons</th>

          <th class="c-ore">Prev</th>
          <th class="c-ore">Eseg</th>
          <th class="c-ore">Rim</th>

          <th class="c-stato">St</th>
          <th class="c-az">Az</th>
        </tr>
      </thead>

      <tbody>
        {% for com in commesse %}

        {# --- NOTE NUOVE: evidenzia finch√© non apri "Vedi" --- #}
        {% set upd = com.note_falegnameria_updated_at %}
        {% set seen = com.note_falegnameria_seen_at %}
        {% set note_nuove = upd and (not seen or seen < upd) %}

        <tr class="
          {% if com.data_inizio %}riga-iniziata{% endif %}
          {% if com.stato == STATO_FALEGNAMERIA %}riga-falegn{% endif %}
          {% if note_nuove %}riga-note-nuove{% endif %}
        ">
          <td class="c-nome" title="{{ com.nome }}">{{ com.nome }}</td>

          <td class="c-tipo" title="{{ com.tipo_intervento }}">{{ com.tipo_intervento }}</td>

          <td class="c-veicolo" title="{{ (com.marca_veicolo or '') ~ ' ' ~ (com.modello_veicolo or '') ~ ' ' ~ (com.dimensioni or '') }}">
            <div class="v1">{{ com.marca_veicolo }} {{ com.modello_veicolo }}</div>
            <div class="v2">{{ com.dimensioni or '-' }}</div>
          </td>

          <td class="c-date">{{ com.data_conferma or '-' }}</td>
          <td class="c-date">{{ com.data_arrivo_materiali or '-' }}</td>
          <td class="c-date">{{ com.data_inizio or '-' }}</td>
          <td class="c-date">{{ com.data_consegna or '-' }}</td>

          <td class="c-ore">{{ com.ore_necessarie or '-' }}</td>
          <td class="c-ore">{{ com.ore_eseguite or '-' }}</td>
          <td class="c-ore">
            {% if com.ore_necessarie and com.ore_eseguite %}
              {{ com.ore_necessarie - com.ore_eseguite }}
            {% else %}
              -
            {% endif %}
          </td>

          <td class="c-stato">
            {% if com.stato == STATO_FALEGNAMERIA %}FAL{% else %}OFF{% endif %}
          </td>

          <td class="c-az azioni">
            <a href="{{ url_for('modifica_commessa', id=com.id) }}"
               class="btn btn-edit" title="Vedi" aria-label="Vedi">üëÅ</a>

            <a href="{{ url_for('conferma_consegna', id=com.id) }}"
               class="btn btn-view" title="Consegna" aria-label="Consegna"
               onclick="return confirm('Segnare come consegnata questa commessa?')">üöö</a>

            <a href="{{ url_for('elimina_commessa', id=com.id) }}"
               class="btn btn-delete" title="Elimina" aria-label="Elimina"
               onclick="return confirm('Eliminare questa commessa?')">üóë</a>

            {% if ENABLE_PORTALI %}
              {% if com.stato == STATO_FALEGNAMERIA %}
                <form method="POST" action="{{ url_for('admin_rientro_officina', id_commessa=com.id) }}" class="inlineform">
                  <button type="submit" class="btn btn-rientro"
                          title="Rientro" aria-label="Rientro"
                          onclick="return confirm('Riportare la commessa in OFFICINA?')">‚Ü©</button>
                </form>
              {% else %}
                <form method="POST" action="{{ url_for('admin_manda_falegnameria', id_commessa=com.id) }}" class="inlineform">
                  <button type="submit" class="btn btn-faleg"
                          title="In falegnameria" aria-label="In falegnameria"
                          onclick="return confirm('Mandare questa commessa in FALEGNAMERIA?')">ü™µ</button>
                </form>
              {% endif %}
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

  </div>
</div>

<style>
/* container: piena larghezza */
.commesse-wrapper{ display:flex; justify-content:center; margin-top:35px; padding:0 16px; }
.commesse-card{ width:100%; max-width:100% !important; }

/* filtri */
.filter-box{
  background:#22283a; border:1px solid #333a50; border-radius:10px;
  padding:15px 20px; margin-bottom:14px;
  box-shadow:0 2px 8px rgba(0,0,0,0.4);
}
.search-row{ display:flex; justify-content:center; flex-wrap:wrap; align-items:center; gap:10px; }
.search-row input{
  flex:1; min-width:260px; padding:10px;
  border-radius:8px; border:1px solid #444;
  background:#1c1f2b; color:#fff; font-size:14px;
}
.filter-buttons{ display:flex; gap:8px; }
.btn-filter,.btn-reset,.btn-apply{
  padding:8px 14px; border-radius:8px; font-size:13px;
  border:none; cursor:pointer; transition:0.2s;
}
.btn-filter{ background:#00b4ff; color:#fff; }
.btn-reset{ background:#ffc107; color:#000; }
.btn-apply{ background:#28a745; color:#fff; }
.advanced-filters{ display:flex; justify-content:center; flex-wrap:wrap; align-items:center; gap:10px; margin-top:12px; font-size:13px; }
.advanced-filters select,.advanced-filters input[type="date"]{
  padding:8px; border-radius:6px; background:#1e2230; color:#fff; border:1px solid #555;
}
.hidden{ display:none; }

/* tabella */
#commesseTable{
  width:100%;
  table-layout:fixed;
  border-collapse:collapse;
  font-size:12px;
  background:#2f3241;
  border-radius:10px;
  overflow:hidden;
}
#commesseTable th, #commesseTable td{
  border:1px solid #444;
  padding:6px 6px;
  text-align:center;
  color:#e0e0e0;
  line-height:1.15;
  vertical-align:middle;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
#commesseTable th{ background:#00a6c7; color:#fff; font-weight:600; }
#commesseTable tbody tr:nth-child(even){ background:#34374a; }

/* evidenze */
#commesseTable tbody tr.riga-iniziata{ background-color:#245430; }
#commesseTable tbody tr.riga-falegn{ outline:2px solid rgba(111,66,193,0.8); outline-offset:-2px; }

/* ‚úÖ evidenzia NOTE NUOVE senza cambiare altezza righe */
#commesseTable tbody tr.riga-note-nuove{
  box-shadow: inset 4px 0 0 rgba(255,193,7,0.95);
}

/* colonne */
.c-nome{ width: 140px; text-align:left; padding-left:10px; }
.c-tipo{ width: 135px; text-align:left; padding-left:10px; }
.c-veicolo{
  width: 150px;
  text-align:left;
  padding-left:10px;
  white-space:normal;
}
.c-date{ width: 92px; font-size:11px; }
.c-ore{ width: 70px; font-size:11px; }
.c-stato{ width: 45px; font-weight:700; }
.c-az{ width: 120px; }

/* veicolo su 2 righe */
.v1{ font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.v2{ opacity:0.85; font-size:11px; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

/* azioni compatte */
.azioni{
  display:flex;
  gap:4px;
  justify-content:flex-end;
  align-items:center;
  flex-wrap:nowrap;
  background:transparent !important;
}
.inlineform{ display:inline-block; margin:0; padding:0; background:transparent !important; }
.azioni .btn{
  width:26px; height:22px;
  display:inline-flex;
  align-items:center; justify-content:center;
  font-size:12px;
  padding:0;
  border-radius:6px;
  color:#fff; text-decoration:none;
  cursor:pointer; border:none; line-height:1;
}
.btn-edit{ background:#28a745; }
.btn-view{ background:#00bfff; }
.btn-delete{ background:#dc3545; }
.btn-faleg{ background:#6f42c1; }
.btn-rientro{ background:#ff8c00; }
</style>

<script>
  const input = document.getElementById("searchInput");
  input.addEventListener("keyup", function() {
    const filter = input.value.toLowerCase();
    const rows = document.querySelectorAll("#commesseTable tbody tr");
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(filter) ? "" : "none";
    });
  });

  const toggleBtn = document.getElementById("toggleAdvanced");
  const filtersBox = document.getElementById("advancedFilters");
  toggleBtn.addEventListener("click", () => filtersBox.classList.toggle("hidden"));

  function resetFiltri(){
    document.getElementById("searchInput").value = "";
    const rows = document.querySelectorAll("#commesseTable tbody tr");
    rows.forEach(r => r.style.display = "");
  }

  function filtraAvanzato(){
    // lo implementiamo dopo
  }
</script>
{% endblock %}
