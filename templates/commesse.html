{% extends "layout.html" %} 
{% block title %}Elenco Commesse{% endblock %}

{% block content %}
<div class="commesse-wrapper">
  <div class="container commesse-card">
    <h1>üìã Elenco Commesse</h1>

    <div class="top-bar">
      <a href="{{ url_for('aggiungi_commessa') }}" class="btn btn-add">‚ûï Nuova Commessa</a>
    </div>

    <div class="filter-box">
      <div class="search-row">
        <input type="text" id="searchInput" placeholder="üîç Cerca per nome, tipo intervento o veicolo...">
        <div class="filter-buttons">
          <button class="btn btn-filter" id="toggleAdvanced" type="button">‚öô Filtri</button>
          <button class="btn btn-reset" type="button" onclick="resetFiltri()">üîÑ Reset</button>
        </div>
      </div>

      <div class="advanced-filters hidden" id="advancedFilters">
        <select id="filterTipo">
          <option value="">Tipo intervento...</option>
          <option value="Carrozzeria">Carrozzeria</option>
          <option value="Allestimento">Allestimento</option>
          <option value="Riparazione">Riparazione</option>
          <option value="Tetto a Soffietto">Tetto a Soffietto</option>
        </select>

        <label>Dal:</label>
        <input type="date" id="filterDataDa">
        <label>Al:</label>
        <input type="date" id="filterDataA">

        <button class="btn btn-apply" type="button" onclick="filtraAvanzato()">Applica</button>
      </div>
    </div>

    <div class="table-scroll">
      <table id="commesseTable">
        <thead>
          <tr>
            <th class="col-id">ID</th>
            <th class="col-nome">Nome</th>
            <th class="col-tipo">Tipo</th>
            <th class="col-marca">Marca</th>
            <th class="col-modello">Modello</th>
            <th class="col-dim">Dim.</th>
            <th class="col-date">Conf.</th>
            <th class="col-date">Arrivo Mat.</th>
            <th class="col-date">Inizio</th>
            <th class="col-date">Consegna</th>
            <th class="col-ore">Ore Prev.</th>
            <th class="col-ore">Ore Eseg.</th>
            <th class="col-ore">Ore Rim.</th>
            <th class="col-stato">Stato</th>
            <th class="col-azioni">Azioni</th>
          </tr>
        </thead>

        <tbody>
          {% for com in commesse %}
          <tr class="
              {% if com.data_inizio %}riga-iniziata{% endif %}
              {% if com.stato == STATO_FALEGNAMERIA %}riga-falegn{% endif %}
          ">
            <td class="col-id">{{ com.id }}</td>

            <td class="col-nome" title="{{ com.nome }}">{{ com.nome }}</td>
            <td class="col-tipo" title="{{ com.tipo_intervento }}">{{ com.tipo_intervento }}</td>
            <td class="col-marca" title="{{ com.marca_veicolo }}">{{ com.marca_veicolo }}</td>
            <td class="col-modello" title="{{ com.modello_veicolo }}">{{ com.modello_veicolo }}</td>
            <td class="col-dim">{{ com.dimensioni or '-' }}</td>

            <td class="col-date">{{ com.data_conferma or '-' }}</td>
            <td class="col-date">{{ com.data_arrivo_materiali or '-' }}</td>
            <td class="col-date">{{ com.data_inizio or '-' }}</td>
            <td class="col-date">{{ com.data_consegna or '-' }}</td>

            <td class="col-ore">{{ com.ore_necessarie or '-' }}</td>
            <td class="col-ore">{{ com.ore_eseguite or '-' }}</td>
            <td class="col-ore">
              {% if com.ore_necessarie and com.ore_eseguite %}
                {{ com.ore_necessarie - com.ore_eseguite }}
              {% else %}
                -
              {% endif %}
            </td>

            <td class="col-stato">
              {% if com.stato %}
                {{ com.stato }}
              {% else %}
                OFFICINA
              {% endif %}
            </td>

            <td class="col-azioni azioni">
              <a href="{{ url_for('modifica_commessa', id=com.id) }}" class="btn btn-edit" title="Vedi">‚úè</a>
              <a href="{{ url_for('conferma_consegna', id=com.id) }}" class="btn btn-view"
                 onclick="return confirm('Segnare come consegnata questa commessa?')" title="Consegna">üöö</a>
              <a href="{{ url_for('elimina_commessa', id=com.id) }}" class="btn btn-delete"
                 onclick="return confirm('Eliminare questa commessa?')" title="Elimina">üóë</a>

              {% if ENABLE_PORTALI %}
                {% if com.stato == STATO_FALEGNAMERIA %}
                  <form method="POST" action="{{ url_for('admin_rientro_officina', id_commessa=com.id) }}" class="inlineform">
                    <button type="submit" class="btn btn-rientro"
                      onclick="return confirm('Riportare la commessa in OFFICINA?')" title="Rientro">‚Ü©</button>
                  </form>
                {% else %}
                  <form method="POST" action="{{ url_for('admin_manda_falegnameria', id_commessa=com.id) }}" class="inlineform">
                    <button type="submit" class="btn btn-faleg"
                      onclick="return confirm('Mandare questa commessa in FALEGNAMERIA?')" title="In falegnameria">ü™µ</button>
                  </form>
                {% endif %}
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>

<style>
/* wrapper */
.commesse-wrapper { display:flex; justify-content:center; margin-top:35px; padding: 0 10px; }
.commesse-card { width:100%; max-width: 100% !important; }

/* filtri */
.filter-box{
  background:#22283a; border:1px solid #333a50; border-radius:10px;
  padding:15px 20px; margin-bottom:20px;
  box-shadow:0 2px 8px rgba(0,0,0,0.4);
}
.search-row{ display:flex; justify-content:center; flex-wrap:wrap; align-items:center; gap:10px; }
.search-row input{
  flex:1; min-width:300px; padding:10px;
  border-radius:8px; border:1px solid #444;
  background:#1c1f2b; color:#fff; font-size:14px;
}
.filter-buttons{ display:flex; gap:8px; }
.btn-filter,.btn-reset,.btn-apply{
  padding:8px 14px; border-radius:8px; font-size:13px;
  border:none; cursor:pointer; transition:0.2s;
}
.btn-filter{ background:#00b4ff; color:#fff; }
.btn-reset{ background:#ffc107; color:#000; }
.btn-apply{ background:#28a745; color:#fff; }
.advanced-filters{ display:flex; justify-content:center; flex-wrap:wrap; align-items:center; gap:10px; margin-top:15px; font-size:13px; }
.advanced-filters select,.advanced-filters input[type="date"]{
  padding:8px; border-radius:6px; background:#1e2230; color:#fff; border:1px solid #555;
}
.hidden{ display:none; }

/* tabella: SOLO commesseTable */
.table-scroll{ overflow-x:auto; border-radius:10px; }
#commesseTable{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
  background:#2f3241;
  border-radius:8px;
  overflow:hidden;
  table-layout: fixed;              /* ‚úÖ fa rispettare le larghezze */
}
#commesseTable th, #commesseTable td{
  border:1px solid #444;
  padding:6px 8px;
  text-align:center;
  color:#e0e0e0;
  line-height:1.2;
  white-space:nowrap;
  vertical-align:middle;
  overflow:hidden;                  /* ‚úÖ evita allargamenti */
  text-overflow:ellipsis;           /* ‚úÖ puntini */
}
#commesseTable th{
  background:#00a6c7; color:#fff; font-weight:600; font-size:12px;
}
#commesseTable tbody tr:nth-child(even){ background:#34374a; }

/* evidenze */
#commesseTable tbody tr.riga-iniziata{ background-color:#245430; }
#commesseTable tbody tr.riga-falegn{ outline:2px solid rgba(111,66,193,0.8); outline-offset:-2px; }

/* colonne (pi√π strette) */
.col-id{ width:45px; }
.col-nome{ width:160px; }
.col-tipo{ width:140px; }
.col-marca{ width:85px; }
.col-modello{ width:95px; }
.col-dim{ width:65px; }
.col-date{ width:80px; }
.col-ore{ width:65px; }
.col-stato{ width:90px; }
.col-azioni{ width:170px; }

/* azioni */
.azioni{
  display:flex;
  gap:4px;
  justify-content:flex-end;
  align-items:center;
  flex-wrap:nowrap;               /* ‚úÖ una riga, non aumenta l‚Äôaltezza */
  background:transparent !important;
}
.inlineform{ display:inline-block; margin:0; padding:0; background:transparent !important; }

/* bottoni compatti (icone) */
.azioni .btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-size:12px;
  padding:4px 6px;
  border-radius:6px;
  color:#fff;
  text-decoration:none;
  cursor:pointer;
  border:none;
  line-height:1;
  min-width: 28px;               /* ‚úÖ tutti uguali e stretti */
}
.btn-edit{ background:#28a745; }
.btn-view{ background:#00bfff; }
.btn-delete{ background:#dc3545; }
.btn-faleg{ background:#6f42c1; }
.btn-rientro{ background:#ff8c00; }
</style>

<script>
  const input = document.getElementById("searchInput");
  input.addEventListener("keyup", function() {
    const filter = input.value.toLowerCase();
    const rows = document.querySelectorAll("#commesseTable tbody tr");
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(filter) ? "" : "none";
    });
  });

  const toggleBtn = document.getElementById("toggleAdvanced");
  const filtersBox = document.getElementById("advancedFilters");
  toggleBtn.addEventListener("click", () => filtersBox.classList.toggle("hidden"));

  function resetFiltri(){
    document.getElementById("searchInput").value = "";
    const rows = document.querySelectorAll("#commesseTable tbody tr");
    rows.forEach(r => r.style.display = "");
  }

  function filtraAvanzato(){
    // se vuoi lo implementiamo dopo, intanto non rompe niente
  }
</script>
{% endblock %}
