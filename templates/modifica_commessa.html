{% extends "layout.html" %}
{% block title %}Modifica Commessa{% endblock %}

{% block content %}
<div class="container" style="margin-top:140px;">

    <h1 style="color:#00b4ff; text-align:center; margin-bottom:35px;">‚Üí Modifica Commessa</h1>

    <div class="form-box">

        <!-- FORM -->
        <form action="{{ url_for('modifica_commessa', id=commessa['id']) }}" 
              method="POST" enctype="multipart/form-data">

            <!-- ROW 1 -->
            <div class="form-row">
                <div class="form-group">
                    <label>Nome Cliente</label>
                    <input type="text" name="nome" value="{{ commessa['nome'] }}" required>
                </div>

                <div class="form-group">
                    <label>Tipo Intervento</label>
                    <select name="tipo_intervento" id="tipo_intervento" onchange="gestisciAltroIntervento()" required>
                        <option value="">-- Seleziona --</option>
                        {% for t in tipi_intervento %}
                            <option value="{{ t }}" {% if commessa['tipo_intervento'] == t %}selected{% endif %}>{{ t }}</option>
                        {% endfor %}
                        <option value="Altro" {% if commessa['tipo_intervento'] not in tipi_intervento %}selected{% endif %}>+ Altro...</option>
                    </select>

                    <input type="text" 
                           name="nuovo_intervento" 
                           id="nuovo_intervento"
                           value="{% if commessa['tipo_intervento'] not in tipi_intervento %}{{ commessa['tipo_intervento'] }}{% endif %}"
                           placeholder="Inserisci nuovo tipo intervento"
                           style="display:none;">
                </div>
            </div>

            <!-- ROW 2 -->
            <div class="form-row">
                <div class="form-group">
                    <label>Marca Veicolo</label>
                    <select name="marca_veicolo" id="marca_veicolo" onchange="gestisciNuovaMarca()">
                        <option value="">-- Seleziona Marca --</option>
                        {% for m in marche %}
                            <option value="{{ m }}" {% if commessa['marca_veicolo'] == m %}selected{% endif %}>{{ m }}</option>
                        {% endfor %}
                        <option value="nuova">+ Aggiungi nuova marca</option>
                    </select>

                    <input type="text" 
                           name="nuova_marca" 
                           id="nuova_marca"
                           placeholder="Inserisci nuova marca"
                           style="display:none; margin-top:5px;">
                </div>

                <div class="form-group">
                    <label>Modello Veicolo</label>
                    <input type="text" name="modello_veicolo" value="{{ commessa['modello_veicolo'] }}" required>
                </div>
            </div>

            <!-- ROW 3 -->
            <div class="form-row">
                <div class="form-group" style="width:100%;">
                    <label>Dimensioni Veicolo</label>
                    <input type="text" name="dimensioni" value="{{ commessa['dimensioni'] or '' }}">
                </div>
            </div>

            <!-- ROW 4 -->
            <div class="form-row">
                <div class="form-group">
                    <label>Data Conferma</label>
                    <input type="date" name="data_conferma" value="{{ commessa['data_conferma'] }}">
                </div>

                <div class="form-group">
                    <label>Data Arrivo Materiali</label>
                    <input type="date" name="data_arrivo_materiali" value="{{ commessa['data_arrivo_materiali'] }}">
                </div>
            </div>

            <!-- ROW 5 -->
            <div class="form-row">
                <div class="form-group">
                    <label>Ore Necessarie</label>
                    <input type="number" name="ore_necessarie" value="{{ commessa['ore_necessarie'] }}" step="0.5">
                </div>

                <div class="form-group">
                    <label>Data Inizio Lavoro</label>
                    <input type="date" name="data_inizio" value="{{ commessa['data_inizio'] }}">
                </div>
            </div>

            <!-- ROW 6 -->
            <div class="form-row">
                <div class="form-group">
                    <label>Data Consegna</label>
                    <input type="date" name="data_consegna" value="{{ commessa['data_consegna'] }}">
                </div>
            </div>

            <!-- NOTE -->
            <div class="form-row">
                <div class="form-group" style="width:100%;">
                    <label>Note Importanti</label>
                    <textarea name="note_importanti" rows="4">{{ commessa['note_importanti'] or '' }}</textarea>
                </div>
            </div>

            <!-- FILE -->
            <div class="form-row">
                <div class="form-group" style="width:100%;">
                    <label>Allegati (foto o PDF)</label>
                    <input type="file" name="file_commessa" multiple accept=".jpg,.jpeg,.png,.pdf">
                </div>
            </div>

            <!-- FILE GIA PRESENTI -->
            {% if files and files|length > 0 %}
            <div class="form-row">
                <div class="form-group" style="width:100%;">
                    <label>üìÇ File gi√† allegati</label>
                    <ul class="file-list">
                        {% for f in files %}
                        <li>
                            <a href="{{ url_for('download_commessa_file', file_id=f.id) }}" target="_blank">
                                üìÑ {{ f.original_name or f.filename }}
                            </a>
                            <small>({{ f.upload_date[:10].replace('-', '/') }})</small>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <!-- BOTTONI -->
            <div style="margin-top:25px; text-align:center;">
                <button type="submit" class="btn btn-primary" 
                        style="background:#00AFFF; padding:10px 25px; border-radius:8px;">
                    üíæ SALVA
                </button>

                <a href="{{ url_for('lista_commesse') }}" 
                   class="btn btn-secondary" 
                   style="margin-left:10px; padding:10px 25px; border-radius:8px;">
                    ‚Üê Torna indietro
                </a>

                <a href="{{ url_for('stampa_commessa', id=id_commessa) }}" 
                   target="_blank"
                   class="btn btn-success" 
                   style="margin-left:10px; padding:10px 25px; border-radius:8px;">
                    üñ® Stampa Commessa
                </a>
            </div>

        </form>
    </div>
</div>

<style>
.form-box {
    background: #1a1c27;
    padding: 25px 30px;
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.4);
}

.form-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.form-group {
    width: 48%;
    display: flex;
    flex-direction: column;
}

label {
    margin-bottom: 5px;
    font-weight: 600;
    color: #00b4ff;
}

input, select, textarea {
    background: #2b2f3c;
    border: 1px solid #555;
    padding: 10px;
    color: #fff;
    border-radius: 6px;
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #00b4ff;
    box-shadow: 0 0 4px #00b4ff;
}

.file-list {
    list-style: none;
    padding: 0;
}
</style>

<script>
function gestisciAltroIntervento() {
    const sel = document.getElementById("tipo_intervento");
    const input = document.getElementById("nuovo_intervento");
    input.style.display = (sel.value === "Altro") ? "block" : "none";
}

function gestisciNuovaMarca() {
    const sel = document.getElementById("marca_veicolo");
    const input = document.getElementById("nuova_marca");
    input.style.display = (sel.value === "nuova") ? "block" : "none";
}

document.addEventListener("DOMContentLoaded", () => {
    gestisciAltroIntervento();
    gestisciNuovaMarca();
});
</script>

{% endblock %}