{% extends "layout.html" %}
{% block title %}Modifica Commessa{% endblock %}

{% block content %}
<div class="container">
    <h1>‚úè Modifica Commessa</h1>

    <div class="form-box">
        <form action="{{ url_for('modifica_commessa', id=commessa['id']) }}" 
              method="POST" enctype="multipart/form-data">

            <div class="form-row">
                <div class="form-group">
                    <label>Nome Cliente</label>
                    <input type="text" name="nome" value="{{ commessa['nome'] }}" required>
                </div>

                <div class="form-group">
                    <label>Tipo Intervento</label>
                    <select name="tipo_intervento" id="tipo_intervento" 
                            onchange="gestisciAltroIntervento()" required>
                        <option value="">-- Seleziona --</option>
                        {% for t in tipi_intervento %}
                        <option value="{{ t }}"
                            {% if commessa['tipo_intervento'] == t %}selected{% endif %}>
                            {{ t }}
                        </option>
                        {% endfor %}

                        <option value="Altro"
                            {% if commessa['tipo_intervento'] not in tipi_intervento %}selected{% endif %}>
                            + Altro...
                        </option>
                    </select>

                    <input type="text" name="nuovo_intervento" id="nuovo_intervento"
                           value="{% if commessa['tipo_intervento'] not in tipi_intervento %}{{ commessa['tipo_intervento'] }}{% endif %}"
                           placeholder="Inserisci nuovo tipo..."
                           style="display:none;">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Marca Veicolo</label>
                    <select name="marca_veicolo" id="marca_veicolo" onchange="gestisciNuovaMarca()" required>
                        <option value="">-- Seleziona Marca --</option>
                        {% for m in marche %}
                        <option value="{{ m }}" {% if commessa['marca_veicolo'] == m %}selected{% endif %}>
                            {{ m }}
                        </option>
                        {% endfor %}
                        <option value="nuova">+ Aggiungi nuova marca...</option>
                    </select>

                    <input type="text" name="nuova_marca" id="nuova_marca"
                           placeholder="Inserisci nuova marca"
                           style="display:none; margin-top:5px;">
                </div>

                <div class="form-group">
                    <label>Modello Veicolo</label>
                    <input type="text" name="modello_veicolo" 
                           value="{{ commessa['modello_veicolo'] }}" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group" style="width:100%;">
                    <label>Dimensioni Veicolo</label>
                    <input type="text" name="dimensioni"
                           value="{{ commessa['dimensioni'] or '' }}">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Data Conferma</label>
                    <input type="date" name="data_conferma" value="{{ commessa['data_conferma'] }}">
                </div>

                <div class="form-group">
                    <label>Data Arrivo Materiali</label>
                    <input type="date" name="data_arrivo_materiali" value="{{ commessa['data_arrivo_materiali'] }}">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Ore Necessarie</label>
                    <input type="number" name="ore_necessarie" step="0.5"
                           value="{{ commessa['ore_necessarie'] }}">
                </div>

                <div class="form-group">
                    <label>Data Inizio Lavoro</label>
                    <input type="date" name="data_inizio" value="{{ commessa['data_inizio'] }}">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Data Consegna</label>
                    <input type="date" name="data_consegna" value="{{ commessa['data_consegna'] }}">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group" style="width:100%;">
                    <label>Note Importanti</label>
                    <textarea name="note_importanti" rows="4">{{ commessa['note_importanti'] or '' }}</textarea>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group" style="width:100%;">
                    <label>Allegati (foto o PDF)</label>
                    <input type="file" name="file_commessa" multiple accept=".jpg,.jpeg,.png,.pdf">
                </div>
            </div>

            {% if files and files|length > 0 %}
            <div class="form-row">
                <div class="form-group" style="width:100%;">
                    <label>üìÇ File gi√† allegati</label>
                    <ul class="file-list">
                        {% for f in files %}
                        <li>
                            <a href="{{ url_for('download_commessa_file', file_id=f.id) }}" target="_blank">
                                üìÑ {{ f.original_name or f.filename }}
                            </a>
                            <small>({{ f.upload_date[:10].replace('-', '/') }})</small>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <!-- üîπ BOTTONI FINALI -->
            <div class="form-actions">
                <button type="submit" class="btn btn-save">üíæ SALVA</button>
                <a href="{{ url_for('lista_commesse') }}" class="btn btn-back">‚¨Ö Torna indietro</a>
            </div>

        </form> <!-- QUI CHIUDE IL FORM CORRETTO -->
    </div>
</div>

<script>
function gestisciAltroIntervento() {
    const s = document.getElementById("tipo_intervento");
    const i = document.getElementById("nuovo_intervento");
    if (s.value === "Altro") { i.style.display="block"; i.required=true; }
    else { i.style.display="none"; i.required=false; }
}

function gestisciNuovaMarca() {
    const s = document.getElementById("marca_veicolo");
    const i = document.getElementById("nuova_marca");
    if (s.value === "nuova") { i.style.display="block"; i.required=true; }
    else { i.style.display="none"; i.required=false; }
}

document.addEventListener("DOMContentLoaded", () => {
    gestisciAltroIntervento();
    gestisciNuovaMarca();
});
</script>
{% endblock %}