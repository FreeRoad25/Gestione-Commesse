{% extends "layout.html" %}
{% block title %}Scarico Magazzino{% endblock %}

{% block content %}
<div class="content-wrapper">
    <h1>ðŸ”½ Scarico Magazzino</h1>

    <form action="{{ url_for('scarico_magazzino') }}" method="POST" class="mag-form">

        <!-- ðŸ”Ž Ricerca -->
        <label for="search_articolo">Cerca articolo (descrizione, codice o codice a barre):</label>
        <input type="text"
               id="search_articolo"
               placeholder="Digita parte di descrizione, codice o barcode">

        <!-- Articolo -->
        <label for="id_articolo">Articolo:</label>
        <select name="id_articolo" id="id_articolo" required>
            <option value="">â€” Seleziona articolo â€”</option>
            {% for art in articoli %}
                <option value="{{ art.id }}"
                        data-descrizione="{{ art.descrizione|upper }}"
                        data-codice="{{ (art.codice or '')|upper }}"
                        data-barcode="{{ (art.codice_barre or '')|upper }}">
                    {{ art.codice }} â€” {{ art.descrizione }}
                </option>
            {% endfor %}
        </select>

        <!-- QuantitÃ  -->
        <label>QuantitÃ  da scaricare:</label>
        <input type="number" step="0.01" name="quantita" placeholder="Inserisci quantitÃ " required>

        <!-- Commessa -->
        <label>Commessa:</label>
        <select name="id_commessa" id="id_commessa" required>
            <option value="">â€” Seleziona commessa â€”</option>
            {% for com in commesse %}
                <option value="{{ com.id }}"
                        {% if id_commessa_default and id_commessa_default|string == com.id|string %}selected{% endif %}>
                    Commessa {{ com.id }} â€” {{ com.nome }}
                </option>
            {% endfor %}
        </select>

        <!-- Note -->
        <label>Note:</label>
        <textarea name="note" placeholder="Annotazioni (facoltativo)"></textarea>

        <!-- Pulsante -->
        <button type="submit" class="btn-confirm">âœ… Conferma Scarico</button>
    </form>
</div>

<style>
.content-wrapper {
    width: 80%;
    margin: 40px auto;
    padding: 40px;
    background: rgba(0, 0, 0, 0.7);
    border-radius: 16px;
    color: white;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
}
h1 {
    color: #ff5555;
    text-align: center;
    margin-bottom: 30px;
}
.mag-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.mag-form label {
    font-weight: bold;
    color: #ccc;
}
.mag-form input,
.mag-form select,
.mag-form textarea {
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #555;
    background: #111;
    color: white;
}
.btn-confirm {
    background-color: #dc3545;
    color: white;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
}
.btn-confirm:hover {
    background-color: #b02a37;
}
</style>

<script>
// Filtro client-side per descrizione, codice e barcode
document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("search_articolo");
    const selectArticolo = document.getElementById("id_articolo");

    searchInput.addEventListener("input", function () {
        const term = this.value.trim().toUpperCase();
        let firstMatchValue = "";

        for (const opt of selectArticolo.options) {
            // salta il placeholder
            if (!opt.value) {
                opt.hidden = false;
                continue;
            }

            const testo = [
                opt.dataset.descrizione || "",
                opt.dataset.codice || "",
                opt.dataset.barcode || ""
            ].join(" ");

            if (!term || testo.indexOf(term) !== -1) {
                opt.hidden = false;
                if (!firstMatchValue) {
                    firstMatchValue = opt.value;
                }
            } else {
                opt.hidden = true;
            }
        }

        // seleziono il primo risultato valido (se esiste)
        if (firstMatchValue) {
            selectArticolo.value = firstMatchValue;
        } else {
            selectArticolo.value = "";
        }
    });
});
</script>
{% endblock %}

